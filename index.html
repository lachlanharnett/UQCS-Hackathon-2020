<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <head>
        <title>Busting</title>
        <link rel="stylesheet" href="css/index.css">
        <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
         integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
         <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
         integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
         crossorigin=""/>
         <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
         integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
         crossorigin=""></script>
         <script src="dependencies/leaflet-routing-machine.js"></script>
         <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <div class="header">
            <img src="./images/logo.svg" class="logo-svg"></img>
        </div>
    </head>
    <body>
        <div class="container">
            <div class="main-container">
                <button type="submit" class="btn btn-dark" onclick="openMapAccess()">Allow access to location</button>
                <p class="text">or</p>
                <input type="text" placeholder="Enter location"></input>
                <br>
                <button type="submit" class="btn btn-dark" id="submit">Submit Location</button>
            </div>
            <div id="mapid"></div>
        </div>
        <script>
        function openMapAccess(){
            var mymap = L.map('mapid').setView([51.505, -0.09], 13);

            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoibmIweWMzMyIsImEiOiJja2dkZmczczMwNmQ1MndwZ29mMTVidzk1In0.fv0DZlTYEdChhpcLDI8OtA'
            }).addTo(mymap);

            retrieveToiletData();
            var toilet = [-27,153];
            geoFindClient((lat, long) => (plotRoute(mymap, lat, long, toilet)));

        }

        var toiletGovernmentSite = "https://data.gov.au/data/api/3/action/datastore_search?resource_id=100da45f-6d1d-40ad-8c47-5a0481f1fbf9&q=";

        /**
         * plot a route from the client's location (given by lat and long)
         * to the given toilet
         * @param map
         * @param lat - latitude of the client
         * @param long - longitude of the client
         * @param toilet - a length 2 array representing the location
         * of the given toilet by lat/long
         */
        function plotRoute(map, lat, long, toilet) {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            L.Routing.control({
                waypoints: [
                    L.latLng(lat, long),
                    L.latLng(toilet[0], toilet[1])
                ],
                routeWhileDragging: true
            }).addTo(map);
        }
        /**
         * Get the client's location
         * @returns - an array of size 2 representing the client's latitude/longitude
         * coordinate or -1 if an eror occured
         */
        function geoFindClient(callback) {
            var options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            result = -1;
            function success(pos) {
                result[0] = pos.coords.latitude;
                result[1] = pos.coords.longitude;
                callback(result[0], result[1]);
                console.log("what up what up");
            }

            function error(err) {
                console.warn(`ERROR(${err.code}): ${err.message}`);
            }

            navigator.geolocation.getCurrentPosition(success, error, options);
        }

        /**
         * 
         * @param length The largest entry number in the function. Cannot be negative
         */
        function createArray(length) {
            
            var arr = new Array(length);
            //Rows are Latitude, Columns are Longitude.
            for (var i = 0; i < arr.length; i++) {
            arr[i] = new Array(2);
            }
            return arr;
        }

        /**
         * THIS GRABS THE DATA FROM THE GOVERNMENT DATABASE. 
         * REQUIRES YOU TO PUSH 'ALLOW ACCESS TO LOCATION' BUTTON!!!
         */
        async function retrieveToiletData() {
            const parsingString = `${toiletGovernmentSite}${location}`;
            console.log(parsingString);

            var JSONDATA;

            //Get the JSON objects
            //THIS IS CORRECTLY PULLING THE GOVERNMENT DATASHEETS.
            const output = axios.get(parsingString)
            .then (async function(response) {
                
                JSONDATA = response;
                //console.log(output);
                console.log("_____________________________________")

                //Successful
                console.log(JSONDATA?.data.result.records[1]);
                //console.log(JSONDATA?.data.result.records[1].Latitude);
                

                //initialise the 2D array here
                var LatLongArray = createArray(JSONDATA?.data.result.total);
                //console.log(LatLongArray);


                var newClientLocation = await Geolocation.getCurrentPosition();
                
                //console.log(newClientLocation.coords.latitude, newClientLocation.coords.longitude);

                //Initialise the arrays for later comparison
                for (var i = 0; i < JSONDATA?.data.result.total; i++) {
                    LatLongArray[i][0] = JSONDATA?.data.result.records[i].Latitude;

                    LatLongArray[i][1] = JSONDATA?.data.result.records[i].Longitude;
                }

            
                //console.log(LatLongArray);
                var minShitterValue = findShortestPath(newClientLocation.coords.latitude, newClientLocation.coords.longitude, LatLongArray);
                console.log("Your location", newClientLocation.coords.latitude, newClientLocation.coords.longitude);
                var nearestToiletPosition = LatLongArray[minShitterValue];
                console.log("Nearest Toilet co-ords", nearestToiletPosition);

                //Time to create the string that the user will click on.
                var googleMapsString = `https://www.google.com/maps/dir/?api=1&origin=${newClientLocation.coords.latitude},${newClientLocation.coords.longitude}&destination=${nearestToiletPosition[0]},${nearestToiletPosition[1]}`;
                console.log(googleMapsString);
                googleMapsURL = googleMapsString;

            }).catch(async function(error) {
                console.log("error");
            })
        }
        /**
         * Returns the entry that is the shortest distance.
         * @param currentLat The user's current latitude
         * @param currentLong  The users's current longitude
         * @param bulkCoordinates The 2D array of values
         */
        function findShortestPath(currentLat, currentLong, bulkCoordinates) {
            var tempLength = new Array(bulkCoordinates.length);
            
            for (var i = 0; i < bulkCoordinates.length; i++) {
            tempLength[i] = pythagoreanTriangle(currentLat, currentLong, bulkCoordinates[i][0], bulkCoordinates[i][1]);
            }

            console.log(tempLength);
            //EACH ENTRY FOR THE TEMPLENGTH CORRESPONDS WITH THE ENTRY IN THE DOUBLE ARRAY.
            //Gotta put in the algorithm to find the shortest entry here.
            //O(n^2) time complexity.
            var currentMin = tempLength[0];
            for (var k = 1; k < tempLength.length; k++) {
            if(currentMin > tempLength[k]) {
                currentMin = tempLength[k];
            }
            }
            //console.log(currentMin);

            var minShitterEntry = 0;
            //Now go back through the array and find which entry it was.
            for (var iterator = 0; iterator < tempLength.length; iterator++) {
            if (currentMin === tempLength[iterator]) {
                minShitterEntry = iterator;
                break;
            }
            }
            
            //BULKCOORDINATES FOR MINSHITTERENTRY IS WHAT WE NEED TO BE USING TO ENTER INTO THE API.
            //console.log(minShitterEntry, currentMin, bulkCoordinates[minShitterEntry]);

            function pythagoreanTriangle(userLat, userLong, compareLat, compareLong) {
                const R = 6373;
                var dlon = compareLong - userLong;
                var dlat = compareLat- userLat;
                var a = Math.pow(Math.sin(dlat/2), 2) + Math.cos(userLat) * Math.cos(compareLat) * Math.pow(Math.sin(dlon/2), 2);
                var c = 2 * Math.atan2( Math.sqrt(a), Math.sqrt(1-a) );
                var d = R * c;
                return d;
            //return Math.sqrt(Math.pow(userLat-compareLat, 2) + Math.pow(userLong-compareLong, 2));
            }

            return minShitterEntry;
        }

        </script>
    </body>
</html>